local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local PathfindingService = game:GetService("PathfindingService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local GuiService = game:GetService("GuiService")

--// Local Player
local Player = Players.LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
local PlayerGui = Player:WaitForChild("PlayerGui")

--// Game-specific Services
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Remotes = ReplicatedStorage:WaitForChild("Remotes")
local Events = ReplicatedStorage:WaitForChild("Events")

--// Macro Settings
local Macro = {
    Enabled = false,
    Farming = false,
    Navigating = false,
    CurrentPattern = "Spiral", -- "Spiral" or "Super-S"
    FarmPoints = {},
    HivePosition = nil,
    FieldPosition = nil,
    CurrentField = nil,
    StuckDetection = {
        Enabled = true,
        LastPosition = nil,
        StuckTime = 0,
        Threshold = 1.0,
        CheckInterval = 0.1
    },
    Movement = {
        Speed = 30,
        SpiralRadius = 30,
        SpiralLoops = 3,
        SuperSPoints = 8,
        PointSpacing = 5
    },
    Collection = {
        InstantTween = true,
        TweenSpeed = 0.1,
        CollectionDistance = 15
    },
    AutoClick = {
        Enabled = true,
        ClickInterval = 0.1,
        CheckTool = true
    }
}

--// UI Elements
local MacroUI = nil
local MainFrame = nil
local StatusLabel = nil

--// Pathfinding Variables
local CurrentPath = nil
local PathComputing = false
local WaypointIndex = 1

--// Token Collection Variables
local CollectibleTokens = {}
local LastTokenCollection = 0

--// Utility Functions
local function GetCurrentTool()
    local backpack = Player:FindFirstChild("Backpack")
    local tool = nil
    
    if Humanoid and Humanoid:FindFirstChildOfClass("Tool") then
        tool = Humanoid:FindFirstChildOfClass("Tool")
    elseif backpack and backpack:FindFirstChildOfClass("Tool") then
        tool = backpack:FindFirstChildOfClass("Tool")
    end
    
    return tool
end

local function GetTokenPositions()
    local tokens = {}
    local collectibles = Workspace:FindFirstChild("Collectibles")
    
    if collectibles then
        for _, token in pairs(collectibles:GetChildren()) do
            if token:IsA("BasePart") and (token.Position - HumanoidRootPart.Position).Magnitude <= Macro.Collection.CollectionDistance then
                table.insert(tokens, token)
            end
        end
    end
    
    return tokens
end

local function GetFieldByPosition(position)
    local fields = Workspace:FindFirstChild("FieldZones")
    if not fields then return nil end
    
    local closestField = nil
    local closestDistance = math.huge
    
    for _, field in pairs(fields:GetChildren()) do
        if field:IsA("BasePart") then
            local distance = (field.Position - position).Magnitude
            if distance < closestDistance then
                closestDistance = distance
                closestField = field
            end
        end
    end
    
    return closestField
end

local function GetHivePosition()
    local hives = Workspace:FindFirstChild("Hives")
    if not hives then return nil end
    
    for _, hive in pairs(hives:GetChildren()) do
        if hive:FindFirstChild("Owner") and hive.Owner.Value == Player then
            return hive.Position
        end
    end
    
    return nil
end

--==========================================
-- STUCK DETECTION SYSTEM
--==========================================

task.spawn(function()
    while true do
        task.wait(Macro.StuckDetection.CheckInterval)
        
        if not Macro.Enabled or not Macro.StuckDetection.Enabled then continue end
        
        local currentPos = HumanoidRootPart.Position
        
        if Macro.StuckDetection.LastPosition then
            local distance = (currentPos - Macro.StuckDetection.LastPosition).Magnitude
            
            if distance < 2 then
                Macro.StuckDetection.StuckTime = Macro.StuckDetection.StuckTime + Macro.StuckDetection.CheckInterval
                
                if Macro.StuckDetection.StuckTime >= Macro.StuckDetection.Threshold then
                    -- Anti-stuck actions
                    Humanoid.Jump = true
                    task.wait(0.2)
                    Humanoid.Jump = false
                    
                    -- Force path recalculation if navigating
                    if Macro.Navigating and CurrentPath then
                        PathComputing = false
                        WaypointIndex = 1
                    end
                    
                    Macro.StuckDetection.StuckTime = 0
                    print("[Stuck Detection] Triggered anti-stuck actions")
                end
            else
                Macro.StuckDetection.StuckTime = 0
            end
        end
        
        Macro.StuckDetection.LastPosition = currentPos
    end
end)

--==========================================
-- PATHFINDING SYSTEM
--==========================================

local function ComputePath(startPos, endPos)
    if PathComputing then return nil end
    
    PathComputing = true
    
    local pathParams = {
        AgentCanJump = true,
        AgentCanClimb = false,
        AgentHeight = 5,
        AgentRadius = 2,
        AgentMaxSlope = 45,
        Costs = {
            Water = math.huge
        }
    }
    
    local success, path = pcall(function()
        return PathfindingService:CreatePath(pathParams)
    end)
    
    if not success then
        PathComputing = false
        return nil
    end
    
    path:ComputeAsync(startPos, endPos)
    
    if path.Status == Enum.PathStatus.Success then
        PathComputing = false
        return path
    end
    
    PathComputing = false
    return nil
end

local function FollowPath(path)
    if not path then return end
    
    local waypoints = path:GetWaypoints()
    CurrentPath = path
    WaypointIndex = 1
    Macro.Navigating = true
    
    while Macro.Enabled and Macro.Navigating and WaypointIndex <= #waypoints do
        local waypoint = waypoints[WaypointIndex]
        
        if waypoint.Action == Enum.PathWaypointAction.Jump then
            Humanoid.Jump = true
        end
        
        -- Smooth movement without MoveToFinished:Wait()
        Humanoid:MoveTo(waypoint.Position)
        
        -- Check if reached waypoint
        while Macro.Enabled and Macro.Navigating and (HumanoidRootPart.Position - waypoint.Position).Magnitude > 4 do
            task.wait(0.05)
            
            -- Check for stuck
            if Macro.StuckDetection.StuckTime >= Macro.StuckDetection.Threshold * 0.5 then
                break
            end
        end
        
        WaypointIndex = WaypointIndex + 1
        task.wait(0.05)
    end
    
    Macro.Navigating = false
    CurrentPath = nil
end

--==========================================
-- MOVEMENT PATTERNS
--==========================================

local function GenerateSpiralPoints(center, radius, loops, pointCount)
    local points = {}
    local angleStep = (2 * math.pi * loops) / pointCount
    
    for i = 1, pointCount do
        local angle = i * angleStep
        local currentRadius = (i / pointCount) * radius
        local x = center.X + currentRadius * math.cos(angle)
        local z = center.Z + currentRadius * math.sin(angle)
        
        table.insert(points, Vector3.new(x, center.Y, z))
    end
    
    return points
end

local function GenerateSuperSPoints(center, width, height, pointCount)
    local points = {}
    local halfWidth = width / 2
    local segmentLength = pointCount / 4
    
    for i = 1, pointCount do
        local x, z
        
        if i <= segmentLength then
            -- Top left to top right
            local t = (i - 1) / (segmentLength - 1)
            x = center.X - halfWidth + t * width
            z = center.Z + height
        elseif i <= segmentLength * 2 then
            -- Top right to middle left
            local t = (i - segmentLength - 1) / (segmentLength - 1)
            x = center.X + halfWidth - t * width
            z = center.Z + height - t * height
        elseif i <= segmentLength * 3 then
            -- Middle left to bottom right
            local t = (i - segmentLength * 2 - 1) / (segmentLength - 1)
            x = center.X - halfWidth + t * width
            z = center.Z - t * height
        else
            -- Bottom right to bottom left
            local t = (i - segmentLength * 3 - 1) / (segmentLength - 1)
            x = center.X + halfWidth - t * width
            z = center.Z - height
        end
        
        table.insert(points, Vector3.new(x, center.Y, z))
    end
    
    return points
end

local function ExecutePattern(center)
    if not Macro.Enabled then return end
    
    local points = {}
    
    if Macro.CurrentPattern == "Spiral" then
        points = GenerateSpiralPoints(
            center,
            Macro.Movement.SpiralRadius,
            Macro.Movement.SpiralLoops,
            50
        )
    elseif Macro.CurrentPattern == "Super-S" then
        points = GenerateSuperSPoints(
            center,
            Macro.Movement.SpiralRadius * 1.5,
            Macro.Movement.SpiralRadius,
            Macro.Movement.SuperSPoints
        )
    end
    
    Macro.Farming = true
    
    for i, point in ipairs(points) do
        if not Macro.Enabled then break end
        
        -- Move to point
        Humanoid:MoveTo(point)
        
        -- Wait until close enough or timeout
        local startTime = tick()
        while Macro.Enabled and (HumanoidRootPart.Position - point).Magnitude > 3 do
            task.wait(0.05)
            
            if tick() - startTime > 5 then
                break
            end
        end
        
        -- Collect tokens during movement
        CollectibleTokens = GetTokenPositions()
        if #CollectibleTokens > 0 then
            for _, token in pairs(CollectibleTokens) do
                if Macro.Collection.InstantTween then
                    -- Instant collection with TweenService
                    local tweenInfo = TweenInfo.new(Macro.Collection.TweenSpeed, Enum.EasingStyle.Linear)
                    local tween = TweenService:Create(HumanoidRootPart, tweenInfo, {CFrame = token.CFrame})
                    tween:Play()
                    tween:Wait()
                end
            end
        end
        
        task.wait(0.1)
    end
    
    Macro.Farming = false
end

--==========================================
-- AUTO CLICKER SYSTEM
--==========================================

task.spawn(function()
    while true do
        task.wait(Macro.AutoClick.ClickInterval)
        
        if not Macro.Enabled or not Macro.AutoClick.Enabled then continue end
        
        if Macro.AutoClick.CheckTool then
            local tool = GetCurrentTool()
            if not tool then continue end
        end
        
        -- Simulate click
        local mouse = Player:GetMouse()
        local clickEvent = mouse and mouse:FindFirstChild("Button1Down")
        
        if clickEvent then
            clickEvent:Fire()
        else
            -- Alternative click method
            local args = {
                [1] = Vector3.new(0, 0, 0),
                [2] = Enum.UserInputType.MouseButton1,
                [3] = false
            }
            
            if Remotes:FindFirstChild("Click") then
                Remotes.Click:FireServer(unpack(args))
            end
        end
    end
end)

--==========================================
-- UI SYSTEM
--==========================================

local function CreateMobileUI()
    -- Create ScreenGui
    MacroUI = Instance.new("ScreenGui")
    MacroUI.Name = "NatroMacroUI"
    MacroUI.Parent = PlayerGui
    MacroUI.ResetOnSpawn = false
    MacroUI.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    -- Main Frame
    MainFrame = Instance.new("Frame")
    MainFrame.Name = "MainFrame"
    MainFrame.Parent = MacroUI
    MainFrame.Size = UDim2.new(0, 300, 0, 400)
    MainFrame.Position = UDim2.new(0.5, -150, 0.5, -200)
    MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    MainFrame.BorderSizePixel = 2
    MainFrame.BorderColor3 = Color3.fromRGB(100, 100, 100)
    MainFrame.Active = true
    MainFrame.Draggable = true
    
    -- Title
    local Title = Instance.new("TextLabel")
    Title.Name = "Title"
    Title.Parent = MainFrame
    Title.Size = UDim2.new(1, 0, 0, 30)
    Title.Position = UDim2.new(0, 0, 0, 0)
    Title.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    Title.Text = "ðŸ Natro Macro Mobile"
    Title.TextColor3 = Color3.fromRGB(255, 255, 255)
    Title.Font = Enum.Font.SourceSansBold
    Title.TextSize = 18
    
    -- Status Label
    StatusLabel = Instance.new("TextLabel")
    StatusLabel.Name = "StatusLabel"
    StatusLabel.Parent = MainFrame
    StatusLabel.Size = UDim2.new(1, -20, 0, 25)
    StatusLabel.Position = UDim2.new(0, 10, 0, 40)
    StatusLabel.BackgroundTransparency = 1
    StatusLabel.Text = "Status: Idle"
    StatusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    StatusLabel.Font = Enum.Font.SourceSans
    StatusLabel.TextSize = 14
    StatusLabel.TextXAlignment = Enum.TextXAlignment.Left
    
    -- Toggle Button
    local ToggleBtn = Instance.new("TextButton")
    ToggleBtn.Name = "ToggleBtn"
    ToggleBtn.Parent = MainFrame
    ToggleBtn.Size = UDim2.new(0.9, 0, 0, 40)
    ToggleBtn.Position = UDim2.new(0.05, 0, 0, 75)
    ToggleBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
    ToggleBtn.Text = "START MACRO"
    ToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    ToggleBtn.Font = Enum.Font.SourceSansBold
    ToggleBtn.TextSize = 16
    ToggleBtn.MouseButton1Click:Connect(function()
        Macro.Enabled = not Macro.Enabled
        if Macro.Enabled then
            ToggleBtn.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
            ToggleBtn.Text = "STOP MACRO"
            StatusLabel.Text = "Status: Running"
        else
            ToggleBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
            ToggleBtn.Text = "START MACRO"
            StatusLabel.Text = "Status: Stopped"
            Macro.Farming = false
            Macro.Navigating = false
        end
    end)
    
    -- Pattern Selector
    local PatternLabel = Instance.new("TextLabel")
    PatternLabel.Name = "PatternLabel"
    PatternLabel.Parent = MainFrame
    PatternLabel.Size = UDim2.new(0.9, 0, 0, 25)
    PatternLabel.Position = UDim2.new(0.05, 0, 0, 125)
    PatternLabel.BackgroundTransparency = 1
    PatternLabel.Text = "Movement Pattern:"
    PatternLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    PatternLabel.Font = Enum.Font.SourceSans
    PatternLabel.TextSize = 14
    
    local PatternDropdown = Instance.new("TextButton")
    PatternDropdown.Name = "PatternDropdown"
    PatternDropdown.Parent = MainFrame
    PatternDropdown.Size = UDim2.new(0.9, 0, 0, 30)
    PatternDropdown.Position = UDim2.new(0.05, 0, 0, 150)
    PatternDropdown.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    PatternDropdown.Text = Macro.CurrentPattern
    PatternDropdown.TextColor3 = Color3.fromRGB(255, 255, 255)
    PatternDropdown.Font = Enum.Font.SourceSans
    PatternDropdown.TextSize = 14
    PatternDropdown.MouseButton1Click:Connect(function()
        if Macro.CurrentPattern == "Spiral" then
            Macro.CurrentPattern = "Super-S"
        else
            Macro.CurrentPattern = "Spiral"
        end
        PatternDropdown.Text = Macro.CurrentPattern
    end)
    
    -- Position Buttons
    local SaveHiveBtn = Instance.new("TextButton")
    SaveHiveBtn.Name = "SaveHiveBtn"
    SaveHiveBtn.Parent = MainFrame
    SaveHiveBtn.Size = UDim2.new(0.9, 0, 0, 35)
    SaveHiveBtn.Position = UDim2.new(0.05, 0, 0, 190)
    SaveHiveBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 200)
    SaveHiveBtn.Text = "ðŸ“ Save Hive Position"
    SaveHiveBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    SaveHiveBtn.Font = Enum.Font.SourceSans
    SaveHiveBtn.TextSize = 14
    SaveHiveBtn.MouseButton1Click:Connect(function()
        Macro.HivePosition = HumanoidRootPart.Position
        StatusLabel.Text = "Status: Hive position saved!"
        print("[UI] Hive position saved:", Macro.HivePosition)
    end)
    
    local SaveFieldBtn = Instance.new("TextButton")
    SaveFieldBtn.Name = "SaveFieldBtn"
    SaveFieldBtn.Parent = MainFrame
    SaveFieldBtn.Size = UDim2.new(0.9, 0, 0, 35)
    SaveFieldBtn.Position = UDim2.new(0.05, 0, 0, 230)
    SaveFieldBtn.BackgroundColor3 = Color3.fromRGB(200, 100, 100)
    SaveFieldBtn.Text = "ðŸŒ» Save Field Position"
    SaveFieldBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    SaveFieldBtn.Font = Enum.Font.SourceSans
    SaveFieldBtn.TextSize = 14
    SaveFieldBtn.MouseButton1Click:Connect(function()
        Macro.FieldPosition = HumanoidRootPart.Position
        Macro.CurrentField = GetFieldByPosition(Macro.FieldPosition)
        StatusLabel.Text = "Status: Field position saved!"
        print("[UI] Field position saved:", Macro.FieldPosition)
    end)
    
    -- Settings
    local SettingsLabel = Instance.new("TextLabel")
    SettingsLabel.Name = "SettingsLabel"
    SettingsLabel.Parent = MainFrame
    SettingsLabel.Size = UDim2.new(0.9, 0, 0, 25)
    SettingsLabel.Position = UDim2.new(0.05, 0, 0, 275)
    SettingsLabel.BackgroundTransparency = 1
    SettingsLabel.Text = "âš™ï¸ Settings"
    SettingsLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    SettingsLabel.Font = Enum.Font.SourceSansBold
    SettingsLabel.TextSize = 14
    
    -- Speed Slider
    local SpeedLabel = Instance.new("TextLabel")
    SpeedLabel.Name = "SpeedLabel"
    SpeedLabel.Parent = MainFrame
    SpeedLabel.Size = UDim2.new(0.4, 0, 0, 20)
    SpeedLabel.Position = UDim2.new(0.05, 0, 0, 300)
    SpeedLabel.BackgroundTransparency = 1
    SpeedLabel.Text = "Speed: " .. Macro.Movement.Speed
    SpeedLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    SpeedLabel.Font = Enum.Font.SourceSans
    SpeedLabel.TextSize = 12
    
    local SpeedSlider = Instance.new("TextButton")
    SpeedSlider.Name = "SpeedSlider"
    SpeedSlider.Parent = MainFrame
    SpeedSlider.Size = UDim2.new(0.5, 0, 0, 20)
    SpeedSlider.Position = UDim2.new(0.45, 0, 0, 300)
    SpeedSlider.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    SpeedSlider.Text = "-"
    SpeedSlider.TextColor3 = Color3.fromRGB(255, 255, 255)
    SpeedSlider.Font = Enum.Font.SourceSans
    SpeedSlider.TextSize = 12
    SpeedSlider.MouseButton1Click:Connect(function()
        Macro.Movement.Speed = math.max(10, Macro.Movement.Speed - 5)
        SpeedLabel.Text = "Speed: " .. Macro.Movement.Speed
    end)
    
    local SpeedSliderPlus = Instance.new("TextButton")
    SpeedSliderPlus.Name = "SpeedSliderPlus"
    SpeedSliderPlus.Parent = MainFrame
    SpeedSliderPlus.Size = UDim2.new(0.5, 0, 0, 20)
    SpeedSliderPlus.Position = UDim2.new(0.45, 0, 0, 320)
    SpeedSliderPlus.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    SpeedSliderPlus.Text = "+"
    SpeedSliderPlus.TextColor3 = Color3.fromRGB(255, 255, 255)
    SpeedSliderPlus.Font = Enum.Font.SourceSans
    SpeedSliderPlus.TextSize = 12
    SpeedSliderPlus.MouseButton1Click:Connect(function()
        Macro.Movement.Speed = math.min(50, Macro.Movement.Speed + 5)
        SpeedLabel.Text = "Speed: " .. Macro.Movement.Speed
    end)
    
    -- Auto Click Toggle
    local AutoClickBtn = Instance.new("TextButton")
    AutoClickBtn.Name = "AutoClickBtn"
    AutoClickBtn.Parent = MainFrame
    AutoClickBtn.Size = UDim2.new(0.9, 0, 0, 30)
    AutoClickBtn.Position = UDim2.new(0.05, 0, 0, 350)
    AutoClickBtn.BackgroundColor3 = Macro.AutoClick.Enabled and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(100, 100, 100)
    AutoClickBtn.Text = "Auto Click: " .. (Macro.AutoClick.Enabled and "ON" or "OFF")
    AutoClickBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    AutoClickBtn.Font = Enum.Font.SourceSans
    AutoClickBtn.TextSize = 14
    AutoClickBtn.MouseButton1Click:Connect(function()
        Macro.AutoClick.Enabled = not Macro.AutoClick.Enabled
        AutoClickBtn.BackgroundColor3 = Macro.AutoClick.Enabled and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(100, 100, 100)
        AutoClickBtn.Text = "Auto Click: " .. (Macro.AutoClick.Enabled and "ON" or "OFF")
    end)
end

--==========================================
-- MAIN MACRO LOGIC
--==========================================

local function MainMacroLoop()
    while true do
        task.wait(0.1)
        
        if not Macro.Enabled then continue end
        
        -- Auto-detect hive position if not set
        if not Macro.HivePosition then
            Macro.HivePosition = GetHivePosition()
        end
        
        -- Farm at saved field position
        if Macro.FieldPosition and not Macro.Farming and not Macro.Navigating then
            -- Navigate to field if too far
            if (HumanoidRootPart.Position - Macro.FieldPosition).Magnitude > 20 then
                StatusLabel.Text = "Status: Navigating to field..."
                local path = ComputePath(HumanoidRootPart.Position, Macro.FieldPosition)
                if path then
                    FollowPath(path)
                end
            else
                -- Execute farming pattern
                StatusLabel.Text = "Status: Farming pattern..."
                ExecutePattern(Macro.FieldPosition)
                
                -- Return to hive after farming
                if Macro.HivePosition and Macro.Enabled then
                    StatusLabel.Text = "Status: Returning to hive..."
                    local path = ComputePath(HumanoidRootPart.Position, Macro.HivePosition)
                    if path then
                        FollowPath(path)
                    end
                end
            end
        end
        
        -- Update status
        if Macro.Farming then
            StatusLabel.Text = "Status: Farming (" .. Macro.CurrentPattern .. ")"
        elseif Macro.Navigating then
            StatusLabel.Text = "Status: Navigating..."
        end
    end
end

--==========================================
-- INITIALIZATION
--==========================================

-- Wait for game to load
task.wait(3)

-- Create UI
CreateMobileUI()

-- Start main loop
task.spawn(MainMacroLoop)

-- Character respawn handling
Player.CharacterAdded:Connect(function(newCharacter)
    Character = newCharacter
    Humanoid = Character:WaitForChild("Humanoid")
    HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
    
    task.wait(1)
    Macro.Farming = false
    Macro.Navigating = false
    print("[Macro] Character respawned - reset states")
end)

print("==========================================")
print("Natro Macro for Bee Swarm Simulator Loaded!")
print("Mobile Optimized | Delta Executor Compatible")
print("==========================================")
print("Features:")
print("âœ“ Spiral & Super-S Movement Patterns")
print("âœ“ Pathfinding Service Navigation")
print("âœ“ Instant Token Collection (TweenService)")
print("âœ“ Anti-Stuck Detection")
print("âœ“ Auto Clicker (Separate Thread)")
print("âœ“ Mobile UI with Position Saving")
print("==========================================")